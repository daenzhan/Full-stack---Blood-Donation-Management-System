<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Donation Centers Map - BloodConnect</title>

  <!-- Yandex Maps -->
  <script src="https://api-maps.yandex.ru/2.1/?apikey=92fb74a1-4389-4f41-8801-8e9d93e4548c&lang=en_US"
          type="text/javascript"></script>

  <!-- Icons -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- Unified BloodConnect Style -->
  <style>
    :root {
      --primary-red: #dc3545;
      --dark-red: #c82333;
      --accent-red: #ff6b7a;
      --light-red: #fff5f5;
      --gradient-red: linear-gradient(135deg, #dc3545, #ff6b7a);
      --gradient-bg: linear-gradient(135deg, #fefafa 0%, #fff5f5 100%);
      --border-light: #ffe6e8;
      --shadow-soft: 0 4px 20px rgba(220, 53, 69, 0.08);
      --shadow-strong: 0 10px 40px rgba(220, 53, 69, 0.15);
      --text-dark: #2d3748;
      --text-light: #718096;
    }

    body {
      background: var(--gradient-bg);
      font-family: 'Inter', sans-serif;
      color: var(--text-dark);
      min-height: 100vh;
      padding-bottom: 50px;
    }

    /* HEADER */
    .page-header {
      background: var(--gradient-red);
      color: white;
      padding: 2rem 0 2.5rem;
      text-align: center;
      border-radius: 0 0 20px 20px;
      box-shadow: var(--shadow-soft);
    }

    .page-header h1 {
      font-weight: 800;
      font-size: 2.5rem;
    }

    .favorites-btn {
      margin-top: 15px;
      display: inline-block;
      padding: 10px 18px;
      font-weight: 600;
      background: white;
      color: var(--primary-red);
      border-radius: 12px;
      box-shadow: var(--shadow-soft);
      text-decoration: none;
      transition: 0.3s ease;
    }

    .favorites-btn:hover {
      box-shadow: var(--shadow-strong);
      transform: translateY(-2px);
    }

    /* CONTROL PANEL */
    .controls-box {
      background: white;
      margin: 30px auto;
      max-width: 900px;
      padding: 25px;
      border-radius: 20px;
      box-shadow: var(--shadow-soft);
      text-align: center;
    }

    .location-btn {
      background: var(--gradient-red);
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 12px;
      cursor: pointer;
      transition: 0.3s ease;
      box-shadow: var(--shadow-soft);
    }

    .location-btn:hover {
      box-shadow: var(--shadow-strong);
      transform: translateY(-2px);
    }

    .location-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .status-box {
      margin-top: 15px;
      padding: 12px;
      border-radius: 12px;
      font-weight: 600;
      display: none;
    }

    .status-loading {
      background: #fff3cd;
      color: #856404;
      display: block;
      border-left: 4px solid #ffca2c;
    }

    .status-success {
      background: #d1edff;
      color: #0c5460;
      display: block;
      border-left: 4px solid #39c0ed;
    }

    .status-error {
      background: #f8d7da;
      color: #721c24;
      display: block;
      border-left: 4px solid #dc3545;
    }

    #map {
      width: 100%;
      height: 600px;
      border-radius: 20px;
      box-shadow: var(--shadow-soft);
    }

    /* LEGEND */
    .legend-box {
      background: white;
      margin-top: 15px;
      padding: 20px;
      border-radius: 15px;
      max-width: 450px;
      box-shadow: var(--shadow-soft);
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin: 8px 0;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 6px;
      margin-right: 10px;
    }

    .user-marker {
      background: #1e88e5;
    }

    .center-marker {
      background: #dc3545;
    }

    /* FAVORITE BUTTONS INSIDE BALLOONS */
    .favorite-btn {
      margin-top: 10px;
      padding: 8px 14px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: 0.3s ease;
    }

    .favorite-add {
      background: var(--primary-red);
      color: white;
    }

    .favorite-remove {
      background: #495057;
      color: white;
    }

    /* LOADER */
    .loading-spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid white;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>

<body>

<!-- PAGE HEADER -->
<div class="page-header">
  <h1>
    <i class="fas fa-map-marker-alt me-2"></i>
    Donation Centers Map
  </h1>
  <a th:href="@{/medcenters/favorites(token=${token}, userId=${userId}, role=${role}, email=${email})}"
     class="favorites-btn">
    ‚òÖ My Favorite Centers
  </a>
</div>

<!-- CONTROLS -->
<div class="controls-box">
  <button id="locationButton" class="location-btn">
    <span class="btn-text">üìç Show My Location</span>
  </button>

  <div id="status" class="status-box">
    <span id="statusText"></span>
  </div>
</div>

<!-- MAP -->
<div class="container">
  <div id="map"></div>

  <!-- LEGEND -->
  <div class="legend-box mt-3">
    <h5 class="fw-bold mb-2">Legend:</h5>
    <div class="legend-item">
      <div class="legend-color user-marker"></div>
      <span>Your Location</span>
    </div>
    <div class="legend-item">
      <div class="legend-color center-marker"></div>
      <span>Medical Centers</span>
    </div>
  </div>
</div>

<!-- JAVASCRIPT -->
<script th:inline="javascript">
  /*<![CDATA[*/
  const centers = /*[[${centers}]]*/ [];
  const token = /*[[${token}]]*/ '';
  const userId = /*[[${userId}]]*/ '';
  const role = /*[[${role}]]*/ '';
  const email = /*[[${email}]]*/ '';

  let map;
  let userPlacemark;

  ymaps.ready(initMap);

  function initMap() {
    map = new ymaps.Map('map', {
      center: [55.76, 37.64],
      zoom: 11,
      controls: ['zoomControl']
    });

    centers.forEach(center => {
      if (center.latitude && center.longitude) {
        const placemark = new ymaps.Placemark(
                [center.latitude, center.longitude],
                {
                  hintContent: center.name,
                  balloonContent: createBalloon(center)
                },
                {
                  preset: 'islands#redIcon'
                }
        );
        map.geoObjects.add(placemark);
      }
    });
  }

  document.getElementById('locationButton')
          .addEventListener('click', showMyLocation);

  function showMyLocation() {
    const btn = document.getElementById('locationButton');
    const status = document.getElementById('status');
    const statusText = document.getElementById('statusText');

    btn.disabled = true;
    btn.innerHTML = '<div class="loading-spinner"></div> Detecting your location...';

    status.className = 'status-box status-loading';
    statusText.textContent = 'Accessing your device location...';

    navigator.geolocation.getCurrentPosition(
            position => {
              const lat = position.coords.latitude;
              const lon = position.coords.longitude;

              status.className = 'status-box status-success';
              statusText.textContent = '‚úî Your location is detected!';

              showOnMap(lat, lon);

              btn.disabled = false;
              btn.innerHTML = '<span class="btn-text">Update My Location</span>';
            },
            error => {
              status.className = 'status-box status-error';
              statusText.textContent = 'Unable to detect location.';
              btn.disabled = false;
              btn.innerHTML = '<span class="btn-text">Try Again</span>';
            }
    );
  }

  function showOnMap(lat, lon) {
    if (userPlacemark) {
      map.geoObjects.remove(userPlacemark);
    }

    userPlacemark = new ymaps.Placemark(
            [lat, lon],
            {
              balloonContent: `<b>You are here</b><br>Lat: ${lat}<br>Lon: ${lon}`
            },
            {
              preset: 'islands#blueIcon'
            }
    );

    map.geoObjects.add(userPlacemark);
    map.setCenter([lat, lon], 13);

    updateDistances(lat, lon);
  }

  function updateDistances(userLat, userLon) {
    map.geoObjects.each(obj => {
      if (obj !== userPlacemark) {
        const coords = obj.geometry.getCoordinates();
        const distance = getDistance(userLat, userLon, coords[0], coords[1]);

        const center = centers.find(c =>
                c.latitude === coords[0] && c.longitude === coords[1]
        );

        if (center) {
          obj.properties.set('balloonContent', createBalloon(center, distance));
        }
      }
    });
  }

  function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;

    const a = Math.sin(dLat/2)**2 +
            Math.cos(lat1 * Math.PI/180) *
            Math.cos(lat2 * Math.PI/180) *
            Math.sin(dLon/2)**2;

    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return (R * c).toFixed(1);
  }

  function createBalloon(center, distance = null) {
    let distanceText = distance
            ? `<p><strong>Distance from you:</strong> ${distance} km</p>`
            : '';

    let isFavorite = center.isFavorite;

    let favoriteButton =
            isFavorite
                    ? `
                    <form action="/medcenters/favorites/${center.med_center_id}/remove" method="post">
                        <input type="hidden" name="token" value="${token}">
                        <input type="hidden" name="donorId" value="${userId}">
                        <input type="hidden" name="role" value="${role}">
                        <input type="hidden" name="email" value="${email}">
                        <button class="favorite-btn favorite-remove">‚òÖ Remove from Favorites</button>
                    </form>`
                    : `
                    <form action="/medcenters/favorites/${center.med_center_id}/add" method="post">
                        <input type="hidden" name="token" value="${token}">
                        <input type="hidden" name="donorId" value="${userId}">
                        <input type="hidden" name="role" value="${role}">
                        <input type="hidden" name="email" value="${email}">
                        <button class="favorite-btn favorite-add">‚òÜ Add to Favorites</button>
                    </form>`;

    return `
            <div style="width: 280px;">
                <h3 style="color: var(--primary-red); margin-bottom: 10px;">
                    ${center.name}
                </h3>

                <p><strong>Address:</strong> ${center.location}</p>
                <p><strong>Phone:</strong> ${center.phone}</p>
                <p><strong>Specialization:</strong> ${center.specialization || 'Not specified'}</p>

                ${distanceText}

                <a href="/medcenters/${center.med_center_id}"
                   style="display:inline-block;margin-top:10px;margin-right:5px;
                          background:#007bff;color:white;padding:8px 14px;border-radius:10px;
                          text-decoration:none;font-weight:600;">
                    Details
                </a>

                ${favoriteButton}
            </div>
        `;
  }

  /*]]>*/
</script>

</body>
</html>
